<!DOCTYPE html>
<html lang="it">
<head>
    <title>Vr Community - Carrello</title>
    <link rel="stylesheet" href="styleCarrello.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:ital,wght@0,100;1,100;1,800&display=swap" rel="stylesheet">
    <link rel="icon" href="immagini/VrIcon.png" type="image/x-icon">
</head>
<body>

<nav>
    <ul>
        <li><a href="Homepage.html" class="casella"><strong>Vr</strong></a></li>
        <li><a href="Shop.html" class="casella">Shop</a></li>
        <li><a href="Carrello.html" class="casella">Carrello</a></li>
        <li><a href="Scopri.html" class="casella">Scopri di piÃ¹</a></li>
        <li><a href="#" class="casella">Altro</a>
            <ul class="dropdown">
                <li><a href="Preferiti.html" class="casella">Preferiti</a></li>
                <li><a href="Cronologia.html" class="casella">Cronologia</a></li>
            </ul>
        </li>
        <li><a href="Profilo.html"><img src="immagini/utente.png" alt="profilo" id="profilo" class="profilo"></a></li>
    </ul>
</nav>

<div class="contenitore-carrello">
    <h1>Il tuo Carrello</h1>
    <div id="elencoCarrello"></div>
    <div class="totale">Totale: â‚¬<span id="totaleCarrello">0</span></div>
    <div class="bottoni-carrello">
        <button class="btn-carrello" onclick="acquista()">ðŸ›’ Acquista</button>
        <button class="btn-carrello" onclick="scaricaRicevuta()">ðŸ§¾ Scarica ricevuta</button>
    </div>
</div>
<br><br><div id="listaStorico" class="contenitore-storico"></div>


<script>
    const elenco = document.getElementById("elencoCarrello");
    const totaleHTML = document.getElementById("totaleCarrello");
    const carrello = JSON.parse(localStorage.getItem("carrello")) || [];
    const img = document.getElementById('profilo');
    img.src = "immagini/" + localStorage.getItem("imgProfilo");

    let totale = 0;

    if (carrello.length === 0) {
        elenco.innerHTML = "<p>Il tuo carrello Ã¨ vuoto</p>";
    } else {
        carrello.forEach((item, index) => {
            let prezzo = item.Prezzo ? parseFloat(item.Prezzo) : 299.99;
            totale += prezzo;
            const div = document.createElement("div");
            div.className = "item-carrello";
            div.innerHTML = `
                <img src="immagini/${item.Img}" alt="${item.Modello}">
                <div class="item-info">
                    <p><strong>Prodotto #${index + 1}</strong></p>
                    <p><strong>Marca:</strong> ${item.Marca}</p>
                    <p><strong>Modello:</strong> ${item.Modello}</p>
                    <p><strong>Prezzo:</strong> â‚¬${prezzo.toFixed(2)}</p>
                </div>
            `;
            elenco.appendChild(div);
        });

        totaleHTML.textContent = totale.toFixed(2);
    }

    function acquista() {
        alert("Acquisto completato! Grazie per aver scelto Vr Community");
        localStorage.removeItem("carrello");
        location.reload();
    }

    function scaricaRicevuta() {
        // Crea HTML per la ricevuta
        let html = `
            <div style="padding: 20px; font-family: Arial, sans-serif;">
                <h1>ðŸ“¦ RICEVUTA - Vr Community Shop Service</h1>
                <p>Data: ${new Date().toLocaleDateString('it-IT')}</p>
                <hr>
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr>
                            <th style="text-align: left;">#</th>
                            <th style="text-align: left;">Prodotto</th>
                            <th style="text-align: right;">Prezzo</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        carrello.forEach((item, index) => {
            let prezzo = item.Prezzo ? parseFloat(item.Prezzo) : 299.99;
            html += `
                <tr>
                    <td>${index + 1}</td>
                    <td>${item.Marca} ${item.Modello}</td>
                    <td style="text-align: right;">â‚¬${prezzo.toFixed(2)}</td>
                </tr>
            `;
        });
        
        html += `
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="2" style="text-align: right; font-weight: bold; padding-top: 20px;">TOTALE:</td>
                            <td style="text-align: right; font-weight: bold; padding-top: 20px;">â‚¬${totale.toFixed(2)}</td>
                        </tr>
                    </tfoot>
                </table>
                <hr>
                <p style="margin-top: 30px;">Firmato: Vr Community Shop Service</p>
            </div>
        `;
        
        // Converti in PDF
        const element = document.createElement('div');
        element.innerHTML = html;
        document.body.appendChild(element);
        
        const opt = {
            margin:       1,
            filename:     `ricevuta_VR_Community_${Date.now()}.pdf`,
            image:        { type: 'jpeg', quality: 0.98 },
            html2canvas:  { scale: 2 },
            jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }
        };
        
        html2pdf().set(opt).from(element).save().then(() => {
            document.body.removeChild(element);
        });
    }

    let storico = [];

    // Carica JSON automaticamente all'apertura con XMLHttpRequest
    window.addEventListener("DOMContentLoaded", function() {
        const xmlhttp = new XMLHttpRequest();
        xmlhttp.open("GET", "storicoOrdini.json", true);
        xmlhttp.send();
        xmlhttp.onreadystatechange = function() {
            if (this.readyState === 4 && this.status === 200) {
                storico = JSON.parse(this.responseText);
                // funzione che stampa lo storico dei prodotti acquistati
                stampaStorico(storico);
            }
        };
    });

    function stampaStorico(st) {
        const container = document.getElementById("listaStorico");
        container.innerHTML = "";

        st.forEach(prodotto => {
            const box = document.createElement("div");
            box.className = "item-storico";

            box.innerHTML = `
                <img src="immagini/${prodotto.img}" alt="${prodotto.modello}">
                <div class="info-storico">
                    <h3>${prodotto.marca} ${prodotto.modello}</h3>
                    <p><strong>Prezzo:</strong> ${prodotto.prezzo}</p>
                    <p><strong>Tipo:</strong> ${prodotto.tipo}</p>
                </div>
            `;

            container.appendChild(box);
        });
    }

</script>
</body>
</html>
